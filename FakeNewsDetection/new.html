<script>
  async function checkNews(event) {
      event.preventDefault(); // Prevent page reload
      const newsText = document.getElementById("news_text").value;

      const response = await fetch("/predict", {
          method: "POST",
          headers: {
              "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `news_text=${encodeURIComponent(newsText)}`
      });

      const result = await response.json();
      let outputHtml = `<h3>Result: ${result.result}</h3>`;

      if (result.confidence) {
          outputHtml += `<p><strong>Confidence:</strong> ${result.confidence}%</p>`;
      }

      // âœ… Correctly Handle Multiple Fact Check Claims
      if (result.fact_check && Array.isArray(result.fact_check) && result.fact_check.length > 0) {
          outputHtml += `<h4>Fact Check Details:</h4><ul>`;
          result.fact_check.forEach(claim => {
              outputHtml += `
                  <li>
                      <p><strong>Claim:</strong> ${claim.claim}</p>
                      <p><strong>Publisher:</strong> ${claim.publisher}</p>
                      <p><strong>Rating:</strong> ${claim.rating}</p>
                      <p><a href="${claim.url}" target="_blank">Read More</a></p>
                      <hr>
                  </li>
              `;
          });
          outputHtml += `</ul>`;
      } else {
          outputHtml += `<p>No relevant claims found in Google Fact Check API.</p>`;
      }

      document.getElementById("output").innerHTML = outputHtml;
  }
</script>



<script>
  async function checkNews(event) {
      event.preventDefault(); // Prevent page reload
      const newsText = document.getElementById("news_text").value;
      
      const response = await fetch("/predict", {
          method: "POST",
          headers: {
              "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `news_text=${encodeURIComponent(newsText)}`
      });

      const result = await response.json();
      let outputHtml = `<h3>Result: ${result.result}</h3>`;

      if (result.confidence) {
          outputHtml += `<p><strong>Confidence:</strong> ${result.confidence}%</p>`;
      }

      if (result.fact_check && result.fact_check !== "No relevant claim found in Google Fact Check API") {
          outputHtml += `
              <h4>Fact Check Details:</h4>
              <p><strong>Claim:</strong> ${result.fact_check.claim}</p>
              <p><strong>Publisher:</strong> ${result.fact_check.publisher}</p>
              <p><strong>Rating:</strong> ${result.fact_check.rating}</p>
              <p><a href="${result.fact_check.url}" target="_blank">Read More</a></p>
          `;
      } else {
          outputHtml += `<p>No relevant claims found in Google Fact Check API.</p>`;
      }

      document.getElementById("output").innerHTML = outputHtml;
  }
</script>




from flask import Flask, render_template, request, jsonify, redirect, url_for, session
from flask_sqlalchemy import SQLAlchemy
from flask_bcrypt import Bcrypt
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
import pickle
import requests
import re
import nltk
from nltk.corpus import stopwords

# Initialize Flask app
app = Flask(__name__)
app.config['SECRET_KEY'] = 'your_secret_key'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///fake_news.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# Initialize database and authentication
db = SQLAlchemy(app)
bcrypt = Bcrypt(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'

# Load the trained model and vectorizer
with open('model.pkl', 'rb') as model_file:
    model = pickle.load(model_file)
with open('vectorizer.pkl', 'rb') as vectorizer_file:
    vectorizer = pickle.load(vectorizer_file)

# Google API Key
GOOGLE_FACT_CHECK_API = "YOUR_GOOGLE_API_KEY"
GOOGLE_NEWS_API = "YOUR_GOOGLE_NEWS_API"

# Download stopwords
nltk.download('stopwords')
stop_words = set(stopwords.words('english'))

# Database Models
class User(db.Model, UserMixin):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password = db.Column(db.String(255), nullable=False)

class NewsEntry(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    news_text = db.Column(db.Text, nullable=False)
    result = db.Column(db.String(20), nullable=False)
    confidence = db.Column(db.Float, nullable=False)

# Authentication Routes
@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

@app.route('/register', methods=['POST'])
def register():
    data = request.json
    hashed_password = bcrypt.generate_password_hash(data['password']).decode('utf-8')
    new_user = User(username=data['username'], email=data['email'], password=hashed_password)
    db.session.add(new_user)
    db.session.commit()
    return jsonify({'message': 'User registered successfully'})

@app.route('/login', methods=['POST'])
def login():
    data = request.json
    user = User.query.filter_by(email=data['email']).first()
    if user and bcrypt.check_password_hash(user.password, data['password']):
        login_user(user)
        return jsonify({'message': 'Login successful'})
    return jsonify({'error': 'Invalid credentials'}), 401

@app.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('index'))

# Fake News Prediction Route
@app.route('/predict', methods=['POST'])
@login_required
def predict():
    news_text = request.form.get('news_text', '')

    if not news_text:
        return jsonify({"error": "No text provided"}), 400

    processed_text = re.sub(r'[^a-zA-Z\s]', ' ', news_text.lower())  
    processed_text = ' '.join([word for word in processed_text.split() if word not in stop_words])

    # Check Google Fact Check API
    fact_check_results = check_fact_with_google(news_text)

    if fact_check_results:
        return jsonify({"result": "Fact Checked", "fact_check": fact_check_results})

    # Use ML Model if no fact check available
    text_vectorized = vectorizer.transform([processed_text])
    prediction = model.predict(text_vectorized)[0]
    confidence = max(model.predict_proba(text_vectorized)[0]) * 100

    result = "Real News" if prediction == 1 else "Fake News"

    # Store in Database
    new_entry = NewsEntry(user_id=current_user.id, news_text=news_text, result=result, confidence=confidence)
    db.session.add(new_entry)
    db.session.commit()

    return jsonify({"result": result, "confidence": f"{confidence:.2f}%", "fact_check": "No relevant claim found"})

# Fetch Fact-Checked News from Google News API
@app.route('/fetch-news')
def fetch_news():
    url = f"https://newsapi.org/v2/top-headlines?category=general&apiKey={GOOGLE_NEWS_API}"
    response = requests.get(url)
    news_data = response.json().get("articles", [])
    
    return jsonify([{
        "title": article.get("title", "No Title"),
        "url": article.get("url", "#"),
        "source": article.get("source", {}).get("name", "Unknown"),
        "publishedAt": article.get("publishedAt", "Unknown Date")
    } for article in news_data[:5]])

if __name__ == '__main__':
    db.create_all()
    app.run(debug=True)
